name: DevSecOps CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  pipeline:
    runs-on: self-hosted

    steps:
      # 1. Checkout repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Set VERSION using timestamp (safe, no semantic version error)
      - name: Set VERSION
        run: echo "VERSION=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV

      # 3. Build Docker image from app/ folder
      - name: Build Docker Image
        run: |
          echo "Building Docker image..."
          docker build --no-cache \
            -t ghcr.io/${{ github.repository_owner }}/devsecops-app:${VERSION} \
            -t ghcr.io/${{ github.repository_owner }}/devsecops-app:latest \
            -f app/Dockerfile app/
        env:
          VERSION: ${{ env.VERSION }}

      # 4. Scan Image with Trivy
      - name: Scan Image with Trivy
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ghcr.io/${{ github.repository_owner }}/devsecops-app:latest
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          exit-code: "0"

      # 5. Login to GHCR
      - name: Login to GHCR
        run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      # 6. Push Docker images
      - name: Push Images
        run: |
          docker push ghcr.io/${{ github.repository_owner }}/devsecops-app:${VERSION}
          docker push ghcr.io/${{ github.repository_owner }}/devsecops-app:latest
        env:
          VERSION: ${{ env.VERSION }}

      # 7. Create GHCR secret for Kubernetes
      - name: Create GHCR Secret
        run: |
          kubectl delete secret ghcr-secret --ignore-not-found=true
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GHCR_PAT }} \
            --docker-email=dummy@example.com

      # 8. Apply Kubernetes manifests
      - name: Apply Manifests
        run: kubectl apply -f k8s/

      # 9. Patch deployment with new Docker image
      - name: Patch Deployment With Version
        run: |
          kubectl set image deployment/devsecops-app web=ghcr.io/${{ github.repository_owner }}/devsecops-app:${VERSION}
        env:
          VERSION: ${{ env.VERSION }}

      # 10. Wait for rollout
      - name: Wait for Rollout
        run: kubectl rollout status deployment/devsecops-app
