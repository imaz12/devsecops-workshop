name: DevSecOps CI/CD



on:

  push:

    branches:

      - main

  pull_request:

    branches:

      - main



jobs:

  build-and-push:

    runs-on: ubuntu-latest



    steps:

      # 1. Checkout repo

      - name: Checkout code

        uses: actions/checkout@v3



      # 2. Set up Docker

      - name: Set up Docker Buildx

        uses: docker/setup-buildx-action@v2



      # 3. Login to GHCR

      - name: Log in to GHCR

        uses: docker/login-action@v2

        with:

          registry: ghcr.io

          username: ${{ github.actor }}

          password: ${{ secrets.GITHUB_TOKEN }}



      # 4. Set version (optional: from tag or commit hash)

      - name: Set VERSION variable

        id: version

        run: |

          VERSION=$(date +%Y%m%d%H%M%S)

          echo "VERSION=$VERSION" >> $GITHUB_ENV



      # 5. Build Docker image

      - name: Build Docker image

        run: |

          docker build -t ghcr.io/imaz12/devsecops-app:$VERSION .

          docker tag ghcr.io/imaz12/devsecops-app:$VERSION ghcr.io/imaz12/devsecops-app:latest



      # 6. Push Docker image

      - name: Push Docker image to GHCR

        run: |

          docker push ghcr.io/imaz12/devsecops-app:$VERSION

          docker push ghcr.io/imaz12/devsecops-app:latest



      # 7. (Optional) Deploy or create secrets

      - name: Create GHCR Secret

        run: |

          echo "Creating GHCR secret..."

          # add your secret creation or deploy commands here
